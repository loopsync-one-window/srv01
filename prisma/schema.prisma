generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum UserStatus {
  PENDING_VERIFICATION
  VERIFIED
  BANNED
}

enum AccountType {
  VISITOR
  CUSTOMER
}

model User {
  id                String   @id @default(cuid())
  fullName          String
  email             String   @unique
  passwordHash      String?
  provider          AuthProvider
  googleId          String?  @unique
  status            UserStatus
  accountType       AccountType
  onboard           Boolean  @default(false)
  trialNotify       Boolean  @default(false)
  credits           Int      @default(0)
  trialCreditsClaimed Boolean @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  emailOtps         EmailOtp[]
  subscriptions     Subscription[]
  userFeatureOverrides UserFeatureOverride[]
  refreshTokenHash  String?
  paymentMethods    PaymentMethod[]
  billingAddresses  BillingAddress[]
  invoices          Invoice[]
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

model Plan {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  price       Int
  currency    String
  billingCycle BillingCycle
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  planFeatures PlanFeature[]
  subscriptions Subscription[]
}

model Subscription {
  id                      String @id @default(cuid())
  userId                  String
  planId                  String
  user                    User @relation(fields: [userId], references: [id])
  plan                    Plan @relation(fields: [planId], references: [id])
  status                  SubscriptionStatus
  startedAt               DateTime
  expiresAt               DateTime
  autoRenew               Boolean @default(true)
  paymentProvider         String
  providerSubscriptionId  String?
  providerPaymentId       String?
  cancelAt                DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAST_DUE
}

enum FeatureDataType {
  BOOLEAN
  NUMBER
}

model Feature {
  id          String @id @default(cuid())
  key         String @unique
  label       String
  description String?
  dataType    FeatureDataType
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  planFeatures PlanFeature[]
  userOverrides UserFeatureOverride[]
}

model PlanFeature {
  id        String @id @default(cuid())
  planId    String
  featureId String
  enabled   Boolean?
  value     Int?
  plan      Plan @relation(fields: [planId], references: [id])
  feature   Feature @relation(fields: [featureId], references: [id])

  @@unique([planId, featureId])
}

model UserFeatureOverride {
  id        String @id @default(cuid())
  userId    String
  featureId String
  enabled   Boolean?
  value     Int?
  user      User @relation(fields: [userId], references: [id])
  feature   Feature @relation(fields: [featureId], references: [id])

  @@unique([userId, featureId])
}

model EmailOtp {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  code      String
  expiresAt DateTime
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model EligibleEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentMethod {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  type            String       // e.g., 'razorpay', 'upi', 'netbanking'
  providerDetails Json         // Store provider-specific details
  isDefault       Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId])
}

model BillingAddress {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  addressLine1  String
  addressLine2  String?
  city          String?
  state         String
  country       String
  pinCode       String
  phoneNumber   String
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([phoneNumber])
}

enum InvoiceType {
  SINGLE_PURCHASE
  SUBSCRIPTION
  REFUND
}

enum InvoiceStatus {
  PAID
  FAILED
  PENDING
}


model Invoice {
  id                 String         @id @default(cuid())
  invoiceNumber      String         @unique
  userId             String
  user               User           @relation(fields: [userId], references: [id])
  type               InvoiceType
  amount             Int
  currency           String
  status             InvoiceStatus
  paymentProvider    String?
  paymentReferenceId String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
}

enum DeveloperStatus {
  PENDING_PAYMENT
  ACTIVE
}

enum DeveloperPaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

model Developer {
  id               String          @id @default(cuid())
  fullName         String
  email            String          @unique
  passwordHash     String
  role             String          @default("DEVELOPER")
  status           DeveloperStatus
  verifiedBadge    Boolean         @default(false)
  license          String?
  refreshTokenHash String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  paymentOrders DeveloperPaymentOrder[]
}

model DeveloperPaymentOrder {
  id          String                 @id @default(cuid())
  developerId String
  developer   Developer              @relation(fields: [developerId], references: [id])
  orderId     String                 @unique
  amount      Float
  currency    String
  status      DeveloperPaymentStatus @default(PENDING)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
}
